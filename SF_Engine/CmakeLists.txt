cmake_minimum_required(VERSION 3.7)

project(SF_Engine LANGUAGES CXX)

# ------------------------------------------------------
# Force out-of-source build
# ------------------------------------------------------
# Only enforce when SF_Engine is built standalone (not as subdirectory)
if(CMAKE_SOURCE_DIR STREQUAL CMAKE_CURRENT_SOURCE_DIR)
    if("${CMAKE_SOURCE_DIR}" STREQUAL "${CMAKE_BINARY_DIR}")
        message(FATAL_ERROR
            "In-source builds are not allowed. Please create a separate build directory:\n"
            "  mkdir build && cd build && cmake .."
        )
    endif()
endif()

# ------------------------------------------------------
# Vulkan SDK
# ------------------------------------------------------
set(VULKAN_SDK "F:/VulkanSDK/1.4.321.1")
set(CMAKE_PREFIX_PATH "${VULKAN_SDK}")

link_directories("${VULKAN_SDK}/Lib")
include_directories("${VULKAN_SDK}/Include")  # for #include <vulkan/vulkan.h>
find_package(Vulkan REQUIRED)

# ------------------------------------------------------
# Compiler & C++ Standard
# ------------------------------------------------------
set(CMAKE_C_COMPILER "gcc")
set(CMAKE_CXX_COMPILER "g++")
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_VERBOSE_MAKEFILE OFF)

# ------------------------------------------------------
# MSVC flags (if used)
# ------------------------------------------------------
if(MSVC)
    foreach(flag_var CMAKE_C_FLAGS CMAKE_C_FLAGS_DEBUG CMAKE_C_FLAGS_RELEASE
                     CMAKE_C_FLAGS_MINSIZEREL CMAKE_C_FLAGS_RELWITHDEBINFO
                     CMAKE_CXX_FLAGS CMAKE_CXX_FLAGS_DEBUG CMAKE_CXX_FLAGS_RELEASE
                     CMAKE_CXX_FLAGS_MINSIZEREL CMAKE_CXX_FLAGS_RELWITHDEBINFO)
        if(${flag_var} MATCHES "/MT")
            string(REGEX REPLACE "/MT" "/MD" ${flag_var} "${${flag_var}}")
        endif()
    endforeach()
endif()

# ------------------------------------------------------
# Third-Party Paths
# ------------------------------------------------------
set(THIRD_PARTY_DIR "../External/3rdParty")
set(THIRD_PARTY_INCLUDES "${THIRD_PARTY_DIR}/include"
"./")
set(THIRD_PARTY_LIB_DIR "${THIRD_PARTY_DIR}/lib")
set(THIRD_PARTY_DLL_DIR "${THIRD_PARTY_DIR}/bin")  # DLLs folder
set(BASE_OUTPUT_DIR "${CMAKE_BINARY_DIR}/bin")     # Output folder

include_directories(${THIRD_PARTY_INCLUDES})

# ------------------------------------------------------
# Engine Sources
# ------------------------------------------------------
file(GLOB_RECURSE ENGINE_SOURCES
    "*.cpp"
    "*.hpp"
    "*.h"
)
list(FILTER ENGINE_SOURCES EXCLUDE REGEX "CMakeLists\\.txt")

# ------------------------------------------------------
# Create the engine library
# ------------------------------------------------------
add_library(SF_Engine SHARED ${ENGINE_SOURCES})
set_target_properties(SF_Engine PROPERTIES
    OUTPUT_NAME "SF_Engine"
    ARCHIVE_OUTPUT_DIRECTORY "${BASE_OUTPUT_DIR}"
    LIBRARY_OUTPUT_DIRECTORY "${BASE_OUTPUT_DIR}"
    RUNTIME_OUTPUT_DIRECTORY "${BASE_OUTPUT_DIR}"
    WINDOWS_EXPORT_ALL_SYMBOLS ON
    CXX_VISIBILITY_PRESET hidden
    VISIBILITY_INLINES_HIDDEN ON
)

target_compile_options(SF_Engine PRIVATE /utf-8)
if(MSVC)
    target_compile_options(SF_Engine PRIVATE /MD$<$<CONFIG:Debug>:d>)
endif()
target_compile_features(SF_Engine PUBLIC cxx_std_20)

# ------------------------------------------------------
# Platform-specific definitions
# ------------------------------------------------------
target_compile_definitions(SF_Engine PUBLIC
    SF_Engine_EXPORTS
    GLM_FORCE_RADIANS
    GLM_FORCE_DEPTH_ZERO_TO_ONE
    GLM_ENABLE_EXPERIMENTAL
)

if (WIN32)
    target_compile_definitions(SF_Engine PUBLIC _PLATFORM_WINDOWS
                                             VK_USE_PLATFORM_WIN32_KHR
                                             NOMINMAX
                                             WIN32_LEAN_AND_MEAN
                                             _CRT_SECURE_NO_WARNINGS)
    target_link_libraries(SF_Engine PUBLIC
        kernel32 user32 gdi32 winspool shell32 ole32 oleaut32
        uuid comdlg32 advapi32
    )
elseif (APPLE)
    target_compile_definitions(SF_Engine PUBLIC _PLATFORM_MACOS
                                             VK_USE_PLATFORM_MACOS_MVK)
elseif (UNIX)
    target_compile_definitions(SF_Engine PUBLIC _PLATFORM_LINUX
                                             VK_USE_PLATFORM_XLIB_KHR)
    target_link_libraries(SF_Engine PUBLIC X11 pthread dl)
endif()

# ------------------------------------------------------
# Link Vulkan
# ------------------------------------------------------
target_link_libraries(SF_Engine PUBLIC Vulkan::Vulkan)

# ------------------------------------------------------
# Link all third-party libraries
# ------------------------------------------------------
# Root lib directory (no recursion)
file(GLOB THIRD_PARTY_ROOT_LIBS "${THIRD_PARTY_LIB_DIR}/*.lib" "${THIRD_PARTY_LIB_DIR}/*.a")

# Configuration-specific libraries (Debug or Release subdirectories)
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    file(GLOB THIRD_PARTY_CONFIG_LIBS "${THIRD_PARTY_LIB_DIR}/Debug/*.lib" "${THIRD_PARTY_LIB_DIR}/Debug/*.a")
    set(DLL_SOURCE_DIR "${THIRD_PARTY_DLL_DIR}/Debug")
else()
    file(GLOB THIRD_PARTY_CONFIG_LIBS "${THIRD_PARTY_LIB_DIR}/Release/*.lib" "${THIRD_PARTY_LIB_DIR}/Release/*.a")
    set(DLL_SOURCE_DIR "${THIRD_PARTY_DLL_DIR}/Release")
endif()

# Combine and link all libraries
set(ALL_THIRD_PARTY_LIBS ${THIRD_PARTY_ROOT_LIBS} ${THIRD_PARTY_CONFIG_LIBS})
if(ALL_THIRD_PARTY_LIBS)
    target_link_libraries(SF_Engine PUBLIC ${ALL_THIRD_PARTY_LIBS})
    message(STATUS "Linking third-party libraries: ${ALL_THIRD_PARTY_LIBS}")
else()
    message(WARNING "No third-party libraries found to link")
endif()

# ------------------------------------------------------
# Copy DLLs to build directory after build
# ------------------------------------------------------
# Copy DLLs from configuration-specific directory (Debug/Release)
if(EXISTS "${DLL_SOURCE_DIR}")
    file(GLOB DLL_FILES "${DLL_SOURCE_DIR}/*.dll")
    foreach(dll ${DLL_FILES})
        add_custom_command(TARGET SF_Engine POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${dll}"
            "${CMAKE_BINARY_DIR}"
            COMMENT "Copying ${dll} to build directory"
        )
    endforeach()
endif()

# Always copy DLLs from root bin directory
if(EXISTS "${THIRD_PARTY_DLL_DIR}")
    file(GLOB ROOT_DLL_FILES "${THIRD_PARTY_DLL_DIR}/*.dll")
    foreach(dll ${ROOT_DLL_FILES})
        add_custom_command(TARGET SF_Engine POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${dll}"
            "${CMAKE_BINARY_DIR}"
            COMMENT "Copying ${dll} to build directory"
        )
    endforeach()
endif()