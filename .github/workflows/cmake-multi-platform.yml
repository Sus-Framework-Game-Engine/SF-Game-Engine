name: Cross-Platform Build (CMake + PowerShell)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install PowerShell (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y powershell

    - name: Run Build Configuration Script
      id: buildconfig
      shell: pwsh
      run: |
        Write-Host "Running buildconfig.ps1..."
        $output = ./buildconfig.ps1 -release

        Write-Host "`n=== Script Output ==="
        Write-Host $output

        # Extract the line starting with: "  cmake --build"
        $cmd = ($output | Select-String -Pattern "cmake --build").ToString().Trim()

        Write-Host "`nExtracted build command: $cmd"

        # Return to workflow
        echo "build_cmd=$cmd" >> $env:GITHUB_OUTPUT

    - name: Execute Build Command
      shell: pwsh
      run: |
        $cmd = "${{ steps.buildconfig.outputs.build_cmd }}"
        Write-Host "Running: $cmd"
        Invoke-Expression $cmd

    - name: Run CTest (if present)
      shell: pwsh
      run: |
        if (Test-Path "./CTestTestfile.cmake") {
          ctest --output-on-failure
        } else {
          Write-Host "No CTest file detected; skipping tests."
        }
name: Cross-Platform Build (CMake + PowerShell)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install PowerShell (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y powershell

    - name: Run Build Configuration Script
      id: buildconfig
      shell: pwsh
      run: |
        Write-Host "Running buildconfig.ps1..."
        $output = ./buildconfig.ps1 -release

        Write-Host "`n=== Script Output ==="
        Write-Host $output

        # Extract the line starting with: "  cmake --build"
        $cmd = ($output | Select-String -Pattern "cmake --build").ToString().Trim()

        Write-Host "`nExtracted build command: $cmd"

        # Return to workflow
        echo "build_cmd=$cmd" >> $env:GITHUB_OUTPUT

    - name: Execute Build Command
      shell: pwsh
      run: |
        $cmd = "${{ steps.buildconfig.outputs.build_cmd }}"
        Write-Host "Running: $cmd"
        Invoke-Expression $cmd

    - name: Run CTest (if present)
      shell: pwsh
      run: |
        if (Test-Path "./CTestTestfile.cmake") {
          ctest --output-on-failure
        } else {
          Write-Host "No CTest file detected; skipping tests."
        }
